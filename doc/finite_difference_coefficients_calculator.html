<!DOCTYPE html>
<html>

<head>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>
<body style="background-color:#366A91" onload="calculateEverything();">
  <div class="container" style="color:#6F6F6F;background-color:#FFFFFF;border-radius:10px" >
    <div style="color:#F0911D;font-family:al-nile">
    <h1 >Finite Difference Coefficients Calculator</h1>
    </div>


    <div class="form-group" >
      <h4> Locations of Sampled Points</h4>
      <input type="text" style="border-color:#F0AA28" class="form-control" id="points" value = "-2,-1,0,1,2" placeholder="e.g. -4,-1,7,11,15" onkeyup="calculateEverything();" ><br>
    </div>

    <div class="input">
      <h4> Derivative Order</h4>
      <input type="text" style="border-color:#F0AA28" class="form-control" id="order" value="1" placeholder="e.g. 4" onkeyup="calculateEverything();"><br> 
    </div>

    <h4> Finite Difference Equation </h4>
    <div id="stencil" style="color:#000000">
    $$\frac{\partial^{(1)}f}{\partial x^{(1)}}\approx$$
    </div>
    <h1></h1>
  </div>
</body>

<script>
  var myPoints
  var myOrder
  var rowVectorString
  var matrixString
  var colVectorString
  var solution

  function calculateEverything(){

    myPoints = $("#points").val()
    myPoints = myPoints.split('[').join('')
    myPoints = myPoints.split(']').join('')
    myPoints = myPoints.split('{').join('')
    myPoints = myPoints.split('}').join('')
    myPoints = myPoints.split('(').join('')
    myPoints = myPoints.split(')').join('')
    myPoints = myPoints.split('<').join('')
    myPoints = myPoints.split('>').join('')
    myPoints = myPoints.split(';').join(',')
    myPoints = myPoints.split('- ').join('')
    myPoints = myPoints.split('--').join('')
    myPoints = myPoints.split(' ').join(',')
    for (i=0; i<10; i++) {
      myPoints = myPoints.split(",,").join(',')
    }
    if (myPoints.slice(-1)=="-") {
      myPoints = myPoints.slice(0, -1);
    }
    if (myPoints.slice(-1)==",") {
      myPoints = myPoints.slice(0, -1);
    }
    while(myPoints.charAt(0) === ',')
        myPoints = myPoints.substr(1);
    myPoints = "[" + myPoints + "]";
    // Check for characters other than commas, periods, minus signs, integers, and brackets.
    if (myPoints.match(/[^,-.\d[]]/)) {
      document.getElementById("stencil").innerHTML = "$$\\mbox{Please enter a comma-separated list of values for the locations of sampled points.}$$";
      document.getElementById("code").innerHTML = "";
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
      return;
    }
    myPoints = JSON.parse(myPoints);

    // Sort by amplitude then by sign (this increases the accuracy of the inverse matrix calculation in MathJS).
    myPoints.sort(function(a,b) {
      if (Math.abs(a) == Math.abs(b)) {
          return Math.sign(a);
        } else {
        return Math.abs(a) - Math.abs(b);
        }
    });

    // Remove duplicates (http://stackoverflow.com/a/9229932/4541374)
    var uniquePoints = [];
    $.each(myPoints, function(i, el){
        if($.inArray(el, uniquePoints) === -1) uniquePoints.push(el);
    });
    myPoints = uniquePoints;

    myOrder = $("#order").val()
    if (myOrder.match(/[^\d]/)) {
      document.getElementById("stencil").innerHTML = "$$\\mbox{Please enter a non-negative integer derivative order.}$$";
      document.getElementById("code").innerHTML = "";
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
      return;
    }
    myOrder = "[" + myOrder + "]"; 
    myOrder = JSON.parse(myOrder);

    if (myOrder[0]>=myPoints.length) {
      document.getElementById("stencil").innerHTML = "$$\\mbox{Please enter a derivative order that is less than the number of points in your stencil.}$$";
      document.getElementById("code").innerHTML = "";
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
      return;
    } else if (!isInt(myOrder[0])) {
      document.getElementById("stencil").innerHTML = "$$\\mbox{Please enter a derivative order.}$$";
      document.getElementById("code").innerHTML = "";
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
      return;
    }

    rowVectorString = "a = ["
    for (i = 0; i < myPoints.length; i++) { 
        rowVectorString += myPoints[i]
        if (i < myPoints.length-1) {
          rowVectorString += ","
        }
    }
    rowVectorString += "]"

    matrixString = "A = ["
    for (i = 0; i < myPoints.length; i++)  {
      for (j = 1; j <= myPoints.length; j++) {
        matrixString += "a[" + j + "]^" + i
        if (j < myPoints.length) {
          matrixString += ","
        }
      }
      if (i < myPoints.length-1) {
        matrixString += "; "
      }
    }
    matrixString += "]"

    colVectorString = "b = ["
    for (i = 0; i < myPoints.length; i++) {
      if (Math.abs(i-myOrder)<1) {
        colVectorString += "factorial(" + myOrder + ")"
      }
      else {
        colVectorString += "0"
      }
      if (i<myPoints.length-1) {
        colVectorString += "; "
      }
    }
    colVectorString += "]"

    var postData = {
         "expr": [
           rowVectorString,
           matrixString,
           colVectorString,
           "x = multiply(inv(A),b)",
         ],
         "precision": 30
        };
    getMatrixInverse(postData);
  }

  function getMatrixInverse(data){
    $.ajax({
      url: "https://api.mathjs.org/v1/",
      type: 'POST',
      data: JSON.stringify(data),
      success: function(response){
        var N = [];
        var D = [];
        var int_frac = [];
        //var solution = [];
        solution = response.result[3]
        solution = solution.split('[').join('')
        solution = solution.split(']').join('')
        solution = "[" + solution +"]"
        solution = JSON.parse(solution);
        for (i=0; i<solution.length; i++) {
          int_frac = approximateFractions(solution[i]);
          N[i] = Math.sign(solution[i])*int_frac[0]
          D[i] = int_frac[1]
        }
        denVectorString = "xLCM = lcm("
        for (i = 0; i <  D.length; i++) { 
            denVectorString += D[i]
            if (i < D.length-1) {
              denVectorString += ","
            }
        }
        denVectorString += ")"
        var postData2 = {
          "expr": [
          denVectorString,
         ],
         "precision": 30
        };
        getLCM(postData2);
      },
      error: function(response){
        console.log("Error loading data");
      }
    });
  };

  function getLCM(data){
    $.ajax({
      url: "https://api.mathjs.org/v1/",
      type: 'POST',
      data: JSON.stringify(data),
      success: function(response){
        xLCM = JSON.parse("[" + response.result[0] + "]");
        var denominator = xLCM
        var numeratorCoefficients = []
        for (i=0; i<solution.length; i++) numeratorCoefficients[i]=Math.round(solution[i]*xLCM);
        // Combine points and coefficients, sort by points, and separate them back out (http://stackoverflow.com/a/11499391/4541374)
        var list = [];
        for (var j in myPoints) 
            list.push({'point': myPoints[j], 'numeratorCoefficient': numeratorCoefficients[j]});
        list.sort(function(a, b) {
            return ((a.point < b.point) ? -1 : ((a.point == b.point) ? 0 : 1));
        });
        var myPoints2 = []
        var numeratorCoefficients2 = []
        for (var k = 0; k < list.length; k++) {
            myPoints2[k] = list[k].point;
            numeratorCoefficients2[k] = list[k].numeratorCoefficient;
        }
        redrawEquation(myPoints2,myOrder,numeratorCoefficients2,denominator)
      },
      error: function(response){
        console.log("Error loading data");
      }
    });
  };

  function redrawEquation(myPoints,myOrder,numeratorCoefficients,denominator) {
    var myEquation = "$$\\frac{\\partial^{(" + myOrder + ")}f}{\\partial x^{(" + myOrder + ")}}\\approx"
    myEquation += "\\frac{"
    for (i=0; i<myPoints.length; i++) {
      var numeratorSign = (numeratorCoefficients[i]>=0 && i!=0 ? "+" : "");
      var pointSign = (myPoints[i]>=0 ? "+" : "")

      myEquation += numeratorSign + numeratorCoefficients[i] + "f(x" + pointSign + myPoints[i] + "h)"
    }
    myEquation += "}{"
    myEquation += denominator + "h^{" + myOrder + "}}$$"
    document.getElementById("stencil").innerHTML = myEquation;
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);

    var myCode = "f_"
    if (myOrder>6) {
      myCode = "f_x" + myOrder;
    } else {
      for (i=0; i<myOrder; i++) {
      myCode += "x"
      }
    }
    myCode += " = ("
    for (i=0; i<myPoints.length; i++) {
      var numeratorSign = (numeratorCoefficients[i]>=0 && i!=0 ? "+" : "");
      var pointSign = (myPoints[i]>=0 ? "+" : "")
      myCode += numeratorSign + numeratorCoefficients[i] + "*f[i" + pointSign + myPoints[i] + "]"
    }
    myCode += ")/(" + denominator + "*1.0*h**" + myOrder + ")"
    document.getElementById("code").innerHTML = myCode;

  }

  function approximateFractions(d) {
    // Credit: http://www.mindspring.com/~alanh/fracs.html
    var d = Math.abs(d)

      var numerators = [0, 1];
      var denominators = [1, 0];
      var frac = [];
    
      var maxNumerator = getMaxNumerator(d);
      var d2 = d;
      var calcD, prevCalcD = NaN;

      for (var i = 2; i < 1000; i++)  {
          var L2 = Math.floor(d2);
          numerators[i] = L2 * numerators[i-1] + numerators[i-2];
      
          if (Math.abs(numerators[i]) > maxNumerator) return frac;
      
          denominators[i] = L2 * denominators[i-1] + denominators[i-2];
      
          calcD = numerators[i] / denominators[i];
          if (calcD == prevCalcD) return frac;
      
          currentNumerator = numerators[i];
          currentDenominator = denominators[i]
          frac = [currentNumerator, currentDenominator];
      
          if (Math.abs(calcD - d)<1e-12*d) return frac;
    
          if (calcD == d) return frac;
      
          prevCalcD = calcD;
      
          d2 = 1/(d2-L2);
      }
  }
  
  function getMaxNumerator(f) {
    // Credit: http://www.mindspring.com/~alanh/fracs.html
     var f2 = null;
     var ixe = f.toString().indexOf("E");
     if (ixe==-1) ixe = f.toString().indexOf("e");
     if (ixe == -1) f2 = f.toString();
     else f2 = f.toString().substring(0, ixe);
  
     var digits = null;
     var ix = f2.toString().indexOf(".");
     if (ix==-1) digits = f2;
     else if (ix==0) digits = f2.substring(1, f2.length);
     else if (ix < f2.length) digits = f2.substring(0, ix) + f2.substring(ix + 1, f2.length);
  
     var L = digits;
  
     var numDigits = L.toString().length;
     var L2 = f;
     var numIntDigits = L2.toString().length;
     if (L2 == 0) numIntDigits = 0;
     var numDigitsPastDecimal = numDigits - numIntDigits;
  
     for (var i=numDigitsPastDecimal; i>0 && L%2==0; i--) L/=2;
     for (var i=numDigitsPastDecimal; i>0 && L%5==0; i--) L/=5;
  
     return L;
  }

  function isInt(n){
    //Credit: http://stackoverflow.com/a/3886106/4541374
      return Number(n) === n && n % 1 === 0;
  }


</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-81863704-1', 'auto');
  ga('send', 'pageview');

</script>

</html>

